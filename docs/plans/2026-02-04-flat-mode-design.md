# Flat Mode 設計

## 概要

ネストされたJSONオブジェクトをドット記法で展開し、フラットな表形式で表示する機能。配列は最初のN要素を省略表示する。

## CLI インターフェース

```bash
jlcat --flat[=DEPTH] [--array-limit=N] [file]
```

### オプション

| オプション | 説明 | デフォルト |
|------------|------|-----------|
| `--flat` | flat mode有効、全深度展開 | - |
| `--flat=N` | N階層まで展開 | 無制限 |
| `--array-limit=N` | 配列表示要素数 | 3 |

### 使用例

```bash
jlcat --flat data.jsonl                    # 全深度展開
jlcat --flat=2 data.jsonl                  # 2階層まで
jlcat --flat --array-limit=5 data.jsonl   # 配列5要素表示
```

## スキーマ決定ルール

### タイミング

最初の読み取りチャンク内の完全な行のみを使用してスキーマを決定する。

### カラム順序

1. **第一レベルキー**: 出現順で追加
2. **展開されたオブジェクト**: 親カラムは非表示、子カラムをアルファベット順で追加
3. **型の決定**: 最初に出現した行の型を優先

### 例

入力:
```json
{"id": 1, "user": {"name": "Alice", "age": 30}, "tags": ["a", "b"]}
```

出力カラム順:
```
| id | user.age | user.name | tags |
|----|----------|-----------|------|
| 1  | 30       | Alice     | a, b |
```

- `id`: 第一レベル、出現順1番目
- `user.age`, `user.name`: 展開、アルファベット順
- `tags`: 第一レベル、出現順3番目

## 後続行の矛盾処理

原則: 最初のバッチで決定したスキーマを維持、先に表示された行を優先

### ケース別処理

| 状況 | 処理 |
|------|------|
| スカラー型の不一致（数値→文字列など） | そのまま表示（混在許容） |
| オブジェクト→スカラー | 親カラムを動的追加してスカラー値を表示、子カラムはnull |
| オブジェクト→別構造オブジェクト | 既存カラムにマッピング、存在しないキーはnull、新規キーは`{...}` |
| スカラー→オブジェクト | 親カラムに`{...}`を表示（展開しない） |

### 例

スキーマ決定時 `user` がオブジェクト `{"name": "Alice"}` の場合:

```
行1: {"user": {"name": "Alice"}}         → user.name="Alice"
行2: {"user": "Bob"}                     → user="Bob", user.name=null (動的追加)
行3: {"user": {"name": "Carol", "x": 1}} → user.name="Carol" (x は {…} 扱い)
行4: {"user": {"age": 25}}               → user.name=null
```

カラム追加は発生時点で行われ、それ以前の行は当該カラムがnullとなる。

## 配列の表示

### 基本ルール

最初のN要素をカンマ区切り、超過分は `...` で省略

### パラメータ

- デフォルト: 3要素
- カスタマイズ: `--array-limit=N`

### 表示例

```
["a", "b"]           → a, b
["a", "b", "c"]      → a, b, c
["a", "b", "c", "d"] → a, b, c, ...
[]                   → (空文字列)
```

### ネストされた配列/オブジェクトを含む場合

```
[1, {"x": 2}, [3, 4]] → 1, {...}, [...], ...
```

- 配列内のオブジェクト → `{...}`
- 配列内の配列 → `[...]`
- スカラー値 → そのまま表示

### 配列内要素の型混在

そのまま表示:
```
[1, "two", true, null] → 1, two, true, null
```

## エッジケースとエラー処理

| ケース | 対応 |
|--------|------|
| 最初のチャンクに完全な行がない | flat mode無効、通常表示にフォールバック |
| 空のJSONオブジェクト `{}` | カラムなし、空行として表示 |
| 深いネスト（depth制限時） | 制限深度以降は `{...}` のまま |
| キー名にドットを含む `{"a.b": 1}` | そのまま `a.b` カラム（最初に出現した形式優先） |
| 同一キーパスの衝突 | 先に出現した行の構造を優先 |
| null値 | `null` として表示 |
| 空配列 `[]` | 空文字列 |
| 空文字列 `""` | 空文字列（nullと区別） |

### 警告/ログ

- フォールバック発生時: stderrへ警告メッセージ
- `--verbose` 時のみ矛盾検出をログ出力（オプション）

## 実装アーキテクチャ

### 影響範囲

1. **CLI (`src/cli.rs`)**: `--flat[=DEPTH]`, `--array-limit=N` オプション追加

2. **スキーマ決定 (`src/core/schema.rs`)**:
   - 最初のチャンクからフラット化カラム構造を決定
   - 動的カラム追加のサポート

3. **TableData (`src/core/table.rs`)**:
   - フラット化ロジック（オブジェクト展開）
   - 配列の省略表示フォーマット
   - 矛盾処理とカラム動的追加

4. **CatRenderer (`src/render/cat.rs`)**: flat mode時の値フォーマット

5. **TUI (`src/render/tui/`)**: flat mode状態の管理と表示

### データフロー

```
Input → Chunk読み取り → スキーマ決定（flat用）
                            ↓
      → 後続行処理 → 矛盾検出 → 動的カラム追加
                            ↓
      → Renderer（CLI/TUI）→ 出力
```

### 新規構造体

- `FlatSchema`: フラット化されたカラム定義を保持
- `FlatConfig`: depth, array_limit などの設定

## 対応範囲

- CLI静的出力
- TUIインタラクティブモード
